<!DOCTYPE html>
<html lang="en">

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Renamed streets of Riga</title>

  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
      background: #f8fafc;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      /* Riga map background from Wikimedia Commons, subtle overlay for readability */
      background-image: url('background.webp');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      /* Add a semi-transparent white overlay for readability */
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(248, 250, 252, 0.75);
      /* matches #f8fafc with opacity */
      z-index: 0;
      pointer-events: none;
    }

    /* Ensure content is above overlay */
    body>* {
      position: relative;
      z-index: 1;
    }

    .controls-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 20px 0 rgba(30, 41, 59, 0.09);
      padding: 2rem 2.5rem;
      margin: 2rem 0 1rem 0;
      display: flex;
      gap: 1.8rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .controls-card label {
      font-size: 1rem;
      color: #1e293b;
      font-weight: 600;
      margin-right: 0.5rem;
    }

    .modern-select {
      appearance: none;
      background: #f1f5f9 url('data:image/svg+xml;utf8,<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 8L10 12L14 8" stroke="%239ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>') no-repeat right 0.7em center/1.1em;
      border: 1.5px solid #e2e8f0;
      border-radius: 12px;
      padding: 0.55em 2.2em 0.55em 1em;
      font-size: 1em;
      color: #334155;
      outline: none;
      min-width: 160px;
      transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 2px 0 rgba(16, 24, 40, 0.04);
      cursor: pointer;
    }

    .modern-select:focus,
    .modern-select:hover {
      border-color: #60a5fa;
      box-shadow: 0 2px 8px 0 rgba(96, 165, 250, 0.09);
    }

    #map {
      width: 80vw;
      max-width: 900px;
      height: 60vh;
      min-height: 350px;
      background: #e0e7ef;
      border-radius: 22px;
      box-shadow: 0 8px 36px 0 rgba(30, 41, 59, 0.13);
      margin-bottom: 2.5rem;
      margin-top: 1.5rem;
      overflow: hidden;
    }

    @media (max-width: 700px) {
      .controls-card {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
        padding: 1.3rem;
      }

      #map {
        width: 95vw;
        height: 45vh;
        min-height: 210px;
      }
    }
  </style>
</head>

<body>
  <!--
  To add another filter:
  1. Copy paste one of the existing filter sections below (ensure unique IDs).
  2. Copy-paste one of the init functions (initRenameYearSelect, initTriggerSelect, initThemeSelect)
      and modify it accordingly. Please note that initRenameYearSelect compares integer values,
      while initTriggerSelect and initThemeSelect compare string values.
  3. Update the filter array in the initApp function to include the new filter.
  4. (optional) Add into onEachFeature function the new property to display in the popup.
  -->
  <div class="controls-card">
    <label for="rename-year-select">Year:</label>
    <select id="rename-year-select" class="modern-select">
      <option value="">Select year</option>
    </select>

    <label for="trigger-select">Trigger:</label>
    <select id="trigger-select" class="modern-select">
      <option value="">Select trigger</option>
    </select>

    <label for="theme-select">Theme:</label>
    <select id="theme-select" class="modern-select">
      <option value="">Select theme</option>
    </select>
  </div>
  <div id='map'>Loading...</div>

  <script>
    // Collects distinct years from the GeoJSON features and populates the year select dropdown.
    function initRenameYearSelect(features, update) {
      const renameYearSelect = document.getElementById('rename-year-select');
      const years = new Set();

      features.forEach(feature => {
        if (feature.properties && feature.properties.rename_yr) {
          years.add(feature.properties.rename_yr);
        }
      });

      const sortedYears = Array.from(years).sort();
      sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        renameYearSelect.appendChild(option);
      });

      renameYearSelect.addEventListener('change', update);
      return (feature) => {
        const selectedYear = renameYearSelect.value;
        return !selectedYear || feature.properties.rename_yr === parseInt(selectedYear, 10);
      };
    }

    // Collects distinct triggers from the GeoJSON features and populates the trigger select dropdown.
    function initTriggerSelect(features, update) {
      const triggerSelect = document.getElementById('trigger-select');
      const triggers = new Set();

      features.forEach(feature => {
        if (feature.properties && feature.properties.trigger) {
          triggers.add(feature.properties.trigger);
        }
      });

      const sortedTriggers = Array.from(triggers).sort();
      sortedTriggers.forEach(trigger => {
        const option = document.createElement('option');
        option.value = trigger;
        option.textContent = trigger;
        triggerSelect.appendChild(option);
      });

      triggerSelect.addEventListener('change', update);
      return (feature) => {
        const selectedTrigger = triggerSelect.value;
        return !selectedTrigger || feature.properties.trigger === selectedTrigger;
      };
    }

    // Collects distinct themes from the GeoJSON features and populates the theme select dropdown.
    function initThemeSelect(features, update) {
      const themeSelect = document.getElementById('theme-select');
      const themes = new Set();

      features.forEach(feature => {
        if (feature.properties && feature.properties.theme_new) {
          themes.add(feature.properties.theme_new);
        }
      });

      const sortedThemes = Array.from(themes).sort();
      sortedThemes.forEach(theme => {
        const option = document.createElement('option');
        option.value = theme;
        option.textContent = theme;
        themeSelect.appendChild(option);
      });

      themeSelect.addEventListener('change', update);
      return (feature) => {
        const selectedTheme = themeSelect.value;
        return !selectedTheme || feature.properties.theme_new === selectedTheme;
      };
    }

    // Initialize the map, setup filter criteria, and add the GeoJSON layer.
    function initApp(geodata) {
      // Filter features with rename=true.
      const renamedStreets = {
        type: 'FeatureCollection',
        features: geodata.features.filter(feature => feature.properties && feature.properties.renamed === true)
      };
      console.log(
        'GeoJSON data loaded. Number of features:', geodata.features.length,
        'Filtered with renamed=true:', renamedStreets.features.length,
      );
      const map = L.map('map').setView([56.947671425035125, 24.10682991450902], 12);

      const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);


      var geodataLayer;
      function updateGeoJSONLayer() {
        if (geodataLayer) {
          map.removeLayer(geodataLayer);
        }
        geodataLayer = L.geoJSON(renamedStreets, {
          filter(feature, layer) {
            return filters.every(filter => filter(feature));
          },
          style(feature) {
            return { color: '#ff0000', weight: 5, opacity: 0.5 };
          },
          onEachFeature(feature, layer) {
            const popupContent = `<strong>${feature.properties.nosaukums || 'Unnamed Street'}</strong><br>
              <strong>Renamed:</strong> ${feature.properties.rename_yr || 'N/A'}<br>
              <strong>Trigger:</strong> ${feature.properties.trigger || 'N/A'}<br>
              <strong>Theme:</strong> ${feature.properties.theme_new || 'N/A'}`;
            layer.bindPopup(popupContent);
          },
        }).addTo(map);
      }

      const filters = [
        initRenameYearSelect(renamedStreets.features, updateGeoJSONLayer),
        initTriggerSelect(renamedStreets.features, updateGeoJSONLayer),
        initThemeSelect(renamedStreets.features, updateGeoJSONLayer),
      ];

      console.log('Initialized');
      updateGeoJSONLayer();
    }

    fetch('data.geojson')
      .then(response => response.json())
      .then(initApp)
      .catch(error => {
        console.error('Error loading GeoJSON:', error);
        alert('Error loading GeoJSON data. Please check the console for details.');
      });
  </script>

</body>

</html>
